{"title":"iOS 头像裁剪、图片裁剪、微信头像裁剪","date":"2019-04-22T08:30:17.000Z","slug":"iOS-edit-image","comments":true,"tags":["UI"],"categories":["iOS"],"updated":"2019-07-10T03:35:32.000Z","content":"<h2 id=\"iOS-头像裁剪、图片裁剪、微信头像裁剪\">iOS 头像裁剪、图片裁剪、微信头像裁剪<a href=\"post/iOS-edit-image#iOS-头像裁剪、图片裁剪、微信头像裁剪\"></a></h2><p>关于图片裁剪，基本上所有涉及到c端用户带基本信息的App基本都会用到，使用频率相对较高。而系统提供的方法只能裁剪出一个正方形，而且经常会出现裁剪框偏移的bug、在X系屏幕上显示效果也不是很好。本文仿微信头像裁剪并添加了矩形裁剪框，供大家参考。</p>\n<p>先看一下效果：</p>\n<h6 id=\"正方形裁剪框\">正方形裁剪框<a href=\"post/iOS-edit-image#正方形裁剪框\"></a></h6><div class=\"article-img\"><p><img src=\"https://s2.ax1x.com/2019/04/24/EEqU91.gif\" alt=\"正方形裁剪框\" data-zoomable></p></div>\n<h6 id=\"矩形裁剪框\">矩形裁剪框<a href=\"post/iOS-edit-image#矩形裁剪框\"></a></h6><div class=\"article-img\"><p><img src=\"https://s2.ax1x.com/2019/04/24/EEqthR.gif\" alt=\"矩形裁剪框\" data-zoomable></p></div>\n<h2 id=\"实现\">实现<a href=\"post/iOS-edit-image#实现\"></a></h2><p>列举一下具体功能：</p>\n<ul>\n<li>图片预览</li>\n<li>捏合手势</li>\n<li>图片旋转</li>\n<li>自定义编辑框（中间白色选框）</li>\n<li>编辑框放大操作</li>\n<li>图片裁剪</li>\n</ul>\n<p>简单说一下实现思路<br>    虽然看起来东西比较少，但是实现的时候还是遇到了挺多坑的，特别是在旋转的时候遇到的问题比较多，改了2次方案最终实现。</p>\n<ol>\n<li><p>最早pass的方案，在<code>UIScrollView</code>中放<code>UIImageView</code>，调整<code>UIImageView</code>在<code>UIScrollView</code>的<code>frame.origin</code>到屏幕中间， 每次旋转直接作用在<code>UIImageView</code>上，旋转完成后重新调整<code>UIImageView</code>在<code>UIScrollView</code>中的位置。</p>\n<p> 遇到问题：每次旋转需要改变<code>UIImageView</code>的锚地，计算十分困难。！进行缩放手势后通过<code>CGAffineTransform</code>旋转要在缩放基础上进行，操作较为繁琐。最后放弃。</p>\n</li>\n<li><p>既然旋转<code>UIImageView</code>不行，那就直接旋转<code>UIScrollView</code>。</p>\n<p> 遇到问题：一开始<code>UIScrollView</code>是称满整个屏幕的，每次旋转后需要修改<code>UIScrollView</code>的<code>frame</code>, 并且每次旋转后需要重置<code>contentSize</code>和<code>contentOffset</code>。</p>\n</li>\n<li><p>最后定下来的方案: <code>UIScrollView</code>只有裁剪框大小，放置于屏幕中间，每次旋转不必重定锚点，也不用重新修改<code>frame</code>不用重置<code>contentSize</code>和<code>contentOffset</code>，大大减少了计算量.</p>\n</li>\n</ol>\n<h2 id=\"View\">View<a href=\"post/iOS-edit-image#View\"></a></h2><ul>\n<li>ImageEditViewController: vc</li>\n<li>ImageActionView: 底部操作栏</li>\n<li>ImageCaptureView: 负责截图的View</li>\n<li>ImageEditView: 负责定位线以及定位框拉伸的View</li>\n</ul>\n<p>视图结构<br><img src=\"https://t1.picb.cc/uploads/2019/04/18/VDOOY0.md.jpg\" alt=\"矩形裁剪框\"><br><img src=\"https://t1.picb.cc/uploads/2019/04/18/VDOMpJ.md.jpg\" alt=\"矩形裁剪框\"></p>\n<h2 id=\"缩放\">缩放<a href=\"post/iOS-edit-image#缩放\"></a></h2><figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"keyword\">void</span>)scrollViewWillBeginZooming:(<span class=\"built_in\">UIScrollView</span> *)scrollView withView:(<span class=\"built_in\">UIView</span> *)view &#123;</span><br><span class=\"line\">    [<span class=\"keyword\">self</span>.editView maskViewHideWithDuration:<span class=\"number\">.2</span>f];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (<span class=\"built_in\">UIView</span> *)viewForZoomingInScrollView:(<span class=\"built_in\">UIScrollView</span> *)scrollView &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>.imageView;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (<span class=\"keyword\">void</span>)scrollViewDidEndZooming:(<span class=\"built_in\">UIScrollView</span> *)scrollView withView:(<span class=\"built_in\">UIView</span> *)view atScale:(<span class=\"built_in\">CGFloat</span>)scale &#123;</span><br><span class=\"line\">    [<span class=\"keyword\">self</span>.scrollView setZoomScale:scale animated:<span class=\"literal\">NO</span>];</span><br><span class=\"line\">    [<span class=\"keyword\">self</span>.editView maskViewShowWithDuration:<span class=\"number\">.2</span>f];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"旋转\">旋转<a href=\"post/iOS-edit-image#旋转\"></a></h2><figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"built_in\">UIView</span> animateWithDuration:<span class=\"number\">.3</span>f animations:^&#123;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.scrollView.transform = <span class=\"built_in\">CGAffineTransformRotate</span>(<span class=\"keyword\">self</span>.scrollView.transform, -M_PI_2);</span><br><span class=\"line\">    &#125; completion:^(<span class=\"built_in\">BOOL</span> finished) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">self</span>.editViewSize.width != <span class=\"keyword\">self</span>.editViewSize.height) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 矩形旋转后位置调整</span></span><br><span class=\"line\">            [<span class=\"keyword\">self</span>.scrollView setZoomScale:<span class=\"number\">1.</span>f animated:<span class=\"literal\">YES</span>];</span><br><span class=\"line\">            [<span class=\"keyword\">self</span>.scrollView setContentOffset:<span class=\"built_in\">CGPointMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>) animated:<span class=\"literal\">YES</span>];</span><br><span class=\"line\">            [<span class=\"built_in\">UIView</span> animateWithDuration:<span class=\"number\">.3</span>f animations:^&#123;</span><br><span class=\"line\">                <span class=\"keyword\">self</span>.scrollView.frame = <span class=\"built_in\">CGRectMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"keyword\">self</span>.editViewSize.width, <span class=\"keyword\">self</span>.editViewSize.height);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (times % <span class=\"number\">2</span> == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">self</span>.editViewSize.width * (<span class=\"keyword\">self</span>.imageViewOriginSize.width/<span class=\"keyword\">self</span>.imageViewOriginSize.height) &gt;= <span class=\"keyword\">self</span>.editViewSize.height) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">self</span>.imageView.frame = <span class=\"built_in\">CGRectMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"keyword\">self</span>.editViewSize.width * (<span class=\"keyword\">self</span>.imageViewOriginSize.width/<span class=\"keyword\">self</span>.imageViewOriginSize.height), <span class=\"keyword\">self</span>.editViewSize.width);  <span class=\"comment\">//宽拉满</span></span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">self</span>.imageView.frame = <span class=\"built_in\">CGRectMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"keyword\">self</span>.editViewSize.height, <span class=\"keyword\">self</span>.editViewSize.height * (<span class=\"keyword\">self</span>.imageViewOriginSize.height/<span class=\"keyword\">self</span>.imageViewOriginSize.width)); <span class=\"comment\">//高拉满</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">self</span>.imageView.frame = <span class=\"built_in\">CGRectMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"keyword\">self</span>.imageViewOriginSize.width, <span class=\"keyword\">self</span>.imageViewOriginSize.height);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; completion:^(<span class=\"built_in\">BOOL</span> finished) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">self</span>.scrollView.contentSize = <span class=\"keyword\">self</span>.imageView.frame.size;</span><br><span class=\"line\">            &#125;];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;];</span><br></pre></td></tr></table></figure>\n<h2 id=\"图片裁剪\">图片裁剪<a href=\"post/iOS-edit-image#图片裁剪\"></a></h2><p>提供了两个图片裁剪方法， 一个是直接截取View， 一个是按照比例截取对应原图上的裁剪区域</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> 截取View获取图片</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"> @return View中的图片</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">- (<span class=\"built_in\">UIImage</span> *)captureImage;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> 截取框对应原图片</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"> @return 原图片</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">- (<span class=\"built_in\">UIImage</span> *)captureOriginalImage;</span><br></pre></td></tr></table></figure>\n<p>裁剪框需要对图片裁剪，这里有两个弱引用是由ViewController传过来的</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">@property</span> (<span class=\"keyword\">nonatomic</span>, <span class=\"keyword\">weak</span>) <span class=\"built_in\">UIImageView</span> *imageView;</span><br><span class=\"line\"><span class=\"keyword\">@property</span> (<span class=\"keyword\">nonatomic</span>, <span class=\"keyword\">weak</span>) <span class=\"built_in\">UIView</span> *captureView;</span><br></pre></td></tr></table></figure>\n<p>对裁剪框的<code>hitTest</code>进行重写， 保证整块屏幕的手势都全部传到<code>UIScrollView</code></p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"built_in\">UIView</span> *)hitTest:(<span class=\"built_in\">CGPoint</span>)point withEvent:(<span class=\"built_in\">UIEvent</span> *)event &#123;</span><br><span class=\"line\">    <span class=\"built_in\">UIView</span> *view = [<span class=\"keyword\">super</span> hitTest:point withEvent:event];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (view) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>.captureView;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>设置不按Bounds裁剪</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"keyword\">instancetype</span>)init &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">self</span> = [<span class=\"keyword\">super</span> init]) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.layer.masksToBounds = <span class=\"literal\">NO</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"图片编辑框\">图片编辑框<a href=\"post/iOS-edit-image#图片编辑框\"></a></h2><ul>\n<li>蒙层 : 除选框外的黑色蒙层</li>\n<li>辅助线 : 定位线</li>\n<li>拉动块</li>\n<li>拉动手势</li>\n<li>Delegate : 完成拉动后将拉动事件传递出去，让<code>UIScrollView</code>进行放大动画</li>\n</ul>\n<p>具体说一下拉动手势的实现<br>因为偷懒直接放了四张图片展示编辑框四个角，直接重写<code>hiteTest</code>让编辑框处理手势。这里只返回接受事件的View</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#pragma mark - private method</span></span><br><span class=\"line\">- (<span class=\"built_in\">UIView</span> *)hitTest:(<span class=\"built_in\">CGPoint</span>)point withEvent:(<span class=\"built_in\">UIEvent</span> *)event &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">self</span>.imageWrap.hidden == <span class=\"literal\">NO</span> &amp;&amp; <span class=\"keyword\">self</span>.isMoving == <span class=\"literal\">NO</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"built_in\">UIView</span> *view <span class=\"keyword\">in</span> <span class=\"keyword\">self</span>.imageWrap.subviews) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">CGRect</span> rect = [view convertRect:view.bounds toView:<span class=\"keyword\">self</span>];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"built_in\">CGRectContainsPoint</span>(rect, point)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> view;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里涉及到一个坐标系的转换的两个相关函数, 简单解释一下相关含义</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"built_in\">CGRect</span>)convertRect:(<span class=\"built_in\">CGRect</span>)rect toView:(<span class=\"keyword\">nullable</span> <span class=\"built_in\">UIView</span> *)view;</span><br><span class=\"line\"><span class=\"comment\">//[v convertRect:rect toView:view];</span></span><br><span class=\"line\"><span class=\"comment\">// v上的rect区域 转换到view上的rect区域</span></span><br><span class=\"line\"></span><br><span class=\"line\">- (<span class=\"built_in\">CGRect</span>)convertRect:(<span class=\"built_in\">CGRect</span>)rect fromView:(<span class=\"keyword\">nullable</span> <span class=\"built_in\">UIView</span> *)view;</span><br><span class=\"line\"><span class=\"comment\">// [v convertRect:rect fromView:view];</span></span><br><span class=\"line\"><span class=\"comment\">//  view上的rect区域 转换到v上的rect区域</span></span><br></pre></td></tr></table></figure>\n<p>相应的point转换也是同样的意思</p>\n<p>拖动手势的处理, 这里只列举左上角处理，更多可以看源码</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"keyword\">void</span>)touchesMoved:(<span class=\"built_in\">NSSet</span>&lt;<span class=\"built_in\">UITouch</span> *&gt; *)touches withEvent:(<span class=\"built_in\">UIEvent</span> *)event &#123;</span><br><span class=\"line\">    <span class=\"built_in\">CGPoint</span> current = [touches.anyObject locationInView:<span class=\"keyword\">self</span>];</span><br><span class=\"line\">    <span class=\"built_in\">CGPoint</span> pre = [touches.anyObject previousLocationInView:<span class=\"keyword\">self</span>];</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (touches.anyObject.view.tag == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 左上</span></span><br><span class=\"line\">        <span class=\"built_in\">CGPoint</span> move = <span class=\"built_in\">CGPointMake</span>(current.x - pre.x, current.y - pre.y);</span><br><span class=\"line\">        <span class=\"built_in\">CGFloat</span> moveFit = fabs(move.x) &gt; fabs(move.y) ? move.x : move.y;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"built_in\">CGFloat</span> x = (<span class=\"keyword\">self</span>.lineWrap.frame.origin.x + moveFit) &gt;= <span class=\"number\">0</span> ? (<span class=\"keyword\">self</span>.lineWrap.frame.origin.x + moveFit) : <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (x &gt;= <span class=\"keyword\">self</span>.previewSize.width/<span class=\"number\">3.</span>f) &#123;</span><br><span class=\"line\">            x = <span class=\"keyword\">self</span>.previewSize.width/<span class=\"number\">3.</span>f;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">CGFloat</span> y = (<span class=\"keyword\">self</span>.previewSize.height/<span class=\"keyword\">self</span>.previewSize.width) * x;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.frame = <span class=\"built_in\">CGRectMake</span>(x, y, <span class=\"keyword\">self</span>.previewSize.width - x, <span class=\"keyword\">self</span>.previewSize.height - y);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>拖动手势结束后，编辑框放大，并把事件传递给vc 处理图片放大</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"keyword\">void</span>)touchesEnded:(<span class=\"built_in\">NSSet</span>&lt;<span class=\"built_in\">UITouch</span> *&gt; *)touches withEvent:(<span class=\"built_in\">UIEvent</span> *)event &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">self</span>.isMoving) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"built_in\">CGRect</span> orignalFrame = <span class=\"keyword\">self</span>.lineWrap.frame;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">self</span>.imageWrap.hidden = <span class=\"literal\">YES</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (touches.anyObject.view.tag == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 左上</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.layer.anchorPoint = <span class=\"built_in\">CGPointMake</span>(<span class=\"number\">1</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (touches.anyObject.view.tag == <span class=\"number\">1</span>) &#123; <span class=\"comment\">// 右上</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.layer.anchorPoint = <span class=\"built_in\">CGPointMake</span>(<span class=\"number\">0</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (touches.anyObject.view.tag == <span class=\"number\">2</span>) &#123; <span class=\"comment\">// 左下</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.layer.anchorPoint = <span class=\"built_in\">CGPointMake</span>(<span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (touches.anyObject.view.tag == <span class=\"number\">3</span>) &#123; <span class=\"comment\">// 右下</span></span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.layer.anchorPoint = <span class=\"built_in\">CGPointMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">self</span>.lineWrap.frame = orignalFrame;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ([<span class=\"keyword\">self</span>.delegate respondsToSelector:<span class=\"keyword\">@selector</span>(editView:anchorPointIndex:rect:)]) &#123;</span><br><span class=\"line\">        [<span class=\"keyword\">self</span>.delegate editView:<span class=\"keyword\">self</span> anchorPointIndex:touches.anyObject.view.tag rect:<span class=\"keyword\">self</span>.lineWrap.frame];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    [<span class=\"built_in\">UIView</span> animateWithDuration:<span class=\"number\">.2</span>f animations:^&#123;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.transform = <span class=\"built_in\">CGAffineTransformMakeScale</span>(<span class=\"keyword\">self</span>.previewSize.width/<span class=\"keyword\">self</span>.lineWrap.frame.size.width, <span class=\"keyword\">self</span>.previewSize.height/<span class=\"keyword\">self</span>.lineWrap.frame.size.height);</span><br><span class=\"line\">    &#125; completion:^(<span class=\"built_in\">BOOL</span> finished) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.isMoving = <span class=\"literal\">NO</span>;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.imageWrap.hidden = <span class=\"literal\">NO</span>;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.layer.anchorPoint = <span class=\"built_in\">CGPointMake</span>(<span class=\"number\">.5</span>f, <span class=\"number\">.5</span>f);</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.transform = <span class=\"built_in\">CGAffineTransformIdentity</span>;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.lineWrap.frame = <span class=\"built_in\">CGRectMake</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"keyword\">self</span>.previewSize.width, <span class=\"keyword\">self</span>.previewSize.height);</span><br><span class=\"line\">    &#125;];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>UIScrollView</code>提供区域放大函数 转换一下坐标系直接调用就可以了</p>\n<figure class=\"highlight objc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (<span class=\"keyword\">void</span>)zoomToRect:(<span class=\"built_in\">CGRect</span>)rect animated:(<span class=\"built_in\">BOOL</span>)animated <span class=\"built_in\">NS_AVAILABLE_IOS</span>(<span class=\"number\">3</span>_0);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#pragma mark - HQEditImageEditViewDelegate</span></span><br><span class=\"line\">- (<span class=\"keyword\">void</span>)editView:(HQEditImageEditView *)editView anchorPointIndex:(<span class=\"built_in\">NSInteger</span>)anchorPointIndex rect:(<span class=\"built_in\">CGRect</span>)rect &#123;</span><br><span class=\"line\">    <span class=\"built_in\">CGRect</span> imageEditRect = [<span class=\"keyword\">self</span>.captureView convertRect:rect toView:<span class=\"keyword\">self</span>.imageView];</span><br><span class=\"line\">    [<span class=\"keyword\">self</span>.scrollView zoomToRect:imageEditRect animated:<span class=\"literal\">YES</span>];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"源码\">源码<a href=\"post/iOS-edit-image#源码\"></a></h2><p>源码放在github 有兴趣的可以下载看下，觉得有所帮助的麻烦帮忙点个星。<br><a href=\"https://github.com/Vesincc/HQImageEditViewController\" target=\"_blank\" rel=\"noopener\">HQImageEditViewController</a></p>\n","prev":{"title":"Runtime(一) 介绍","slug":"iOS-runtime-node-1"},"next":{"title":"Hello world","slug":"helloworld"},"link":"https://vesincc.github.io/post/iOS-edit-image/","toc":[{"title":"iOS 头像裁剪、图片裁剪、微信头像裁剪","id":"iOS-头像裁剪、图片裁剪、微信头像裁剪","index":"1"},{"title":"实现","id":"实现","index":"2"},{"title":"View","id":"View","index":"3"},{"title":"缩放","id":"缩放","index":"4"},{"title":"旋转","id":"旋转","index":"5"},{"title":"图片裁剪","id":"图片裁剪","index":"6"},{"title":"图片编辑框","id":"图片编辑框","index":"7"},{"title":"源码","id":"源码","index":"8"}],"reward":true,"copyright":{"custom":"本文遵守 CC BY-NC-ND 4.0 请保持转载后文章内容的完整，以及文章出处。本人保留所有版权相关权利。"}}